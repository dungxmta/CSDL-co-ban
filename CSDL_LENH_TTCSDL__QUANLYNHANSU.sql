create database CSDL_LENH_TTCSDL
GO
USE CSDL_LENH_TTCSDL
---TAO CAC BANG
CREATE TABLE PHONGBAN(
			 MAPB NCHAR(10) PRIMARY KEY,
			 TENPB NVARCHAR(50),
			 DIADIEM NVARCHAR(50),
			 MATP NCHAR(10)
			 )
--SUA BANG PHONGBAN THEM VAO COT NGAYNHANCHUC
ALTER TABLE PHONGBAN ADD NGAYNC DATE

---TAO BANG NHANVIEN
CREATE TABLE NHANVIEN(
			 MANV NCHAR(10) PRIMARY KEY,
			 HOTEN NVARCHAR(40),
			 GT NCHAR(3) CHECK (GT IN ('NAM','NU')),
			 NGAYSINH DATE,
			 LUONG INT DEFAULT 3000000,
			 MANGS NCHAR(10),
			 MAPB NCHAR(10) REFERENCES PHONGBAN(MAPB)
			 )
--SET COT HOTEN TRONG BANG NHANVIEN KO PHAI LA NOT NULL
ALTER TABLE NHANVIEN
	ALTER COLUMN HOTEN NVARCHAR(40) NOT NULL

---TAO BANG DU AN
CREATE TABLE DUAN(
			 MADA NCHAR(10) PRIMARY KEY,
			 TENDA NVARCHAR(50) NOT NULL,
			 MAPB NCHAR(10) REFERENCES PHONGBAN(MAPB)
			 )

---TAO BANG PHAN CONG
CREATE TABLE PHANCONG(
			 MADA NCHAR(10) NOT NULL REFERENCES DUAN(MADA),
			 MANV NCHAR(10) NOT NULL REFERENCES NHANVIEN(MANV),
			 SOGIO NUMERIC(3,1),
			 PRIMARY KEY(MADA,MANV)
			 )
--neu dat Primary key cuoi cung phai khai bao Trường co thuoc tinh NOT NULL

---TAO BANG THAN NHAN
CREATE TABLE THANNHAN(
			 HOTEN NVARCHAR(50),
			 GT NCHAR(3) CHECK (GT IN ('NAM','NU')),
			 NGAYSINH DATE,
			 QUANHE NCHAR(10),
			 MANV NCHAR(10) REFERENCES NHANVIEN(MANV),
			 )
--UPDATE PRIMARY KEY
ALTER TABLE THANNHAN
	ALTER COLUMN HOTEN NVARCHAR(50) NOT NULL 
ALTER TABLE THANNHAN
	ALTER COLUMN MANV NCHAR(10) NOT NULL
ALTER TABLE THANNHAN ADD PRIMARY KEY(HOTEN,MANV)
---XOA DATABASE, TABLE: DROP DATABASE/TABLE TEN_CSDL/TEN BANG


---THEM DU LIEU VAO BANG
INSERT INTO PHONGBAN VALUES('PB01',N'Hành chính',N'Hà Nội',NULL,NULL)
SELECT * FROM PHONGBAN

INSERT INTO PHONGBAN(MAPB,TENPB) VALUES('PB02','Tổng hợp')

UPDATE PHONGBAN
SET TENPB=N'Tổng hợp'
WHERE MAPB='PB02'
SELECT * FROM PHONGBAN

INSERT INTO PHONGBAN(MAPB,TENPB,DIADIEM)
VALUES('PB03',N'Nghiên cứu',N'Hà Nội'),
('PB04',N'Thống kê',N'Hà Nội'),
('PB05',N'Kế hoạch',N'Hà Nội')


---XOA DU LIEU TRONG BANG
DELETE FROM PHONGBAN
WHERE MAPB='P1'

DELETE PHONGBAN
WHERE MAPB='PB05'

----------------------------------
---Cập nhật lại DL
UPDATE PHONGBAN
SET DIADIEM=N'Hà Nội'
WHERE MAPB='PB02'

INSERT INTO PHONGBAN(MAPB,TENPB,DIADIEM)
VALUES('PB05',N'Kế hoạch',N'Hà Nội')


---NHAP DL VAO CAC BANG
SELECT * FROM PHONGBAN

UPDATE PHONGBAN
SET MATP='TP01',NGAYNC='2015-12-12'
WHERE MAPB='PB01'
UPDATE PHONGBAN
SET MATP='TP02',NGAYNC='2014-10-12'
WHERE MAPB='PB02'
UPDATE PHONGBAN
SET MATP='TP03',NGAYNC='2013-11-12'
WHERE MAPB='PB03'
UPDATE PHONGBAN
SET MATP='TP04',NGAYNC='2016-11-12'
WHERE MAPB='PB04'
UPDATE PHONGBAN
SET MATP='TP05',NGAYNC='2010-09-12'
WHERE MAPB='PB05'

SELECT * FROM NHANVIEN

INSERT INTO NHANVIEN VALUES('NV01',N'BÙI TIẾN DŨNG','NAM','1995-12-12','5000000','NV02','PB01')

INSERT INTO NHANVIEN 
VALUES('NV02',N'BÙI ĐỨC DUY','NAM','1995-11-12','5000000','NV01','PB02'),
('NV03',N'BÙI MẠNH CƯỜNG','NAM','1995-10-10','5000000','NV01','PB02'),
('NV04',N'ĐỖ QUANG VŨ','NAM','1995-10-12','5000000','NV03','PB03'),
('NV05',N'DƯƠNG VĂN HIẾN','NAM','1995-09-07','5000000','NV04','PB04'),
('NV06',N'ĐỖ HỮU THỊNH','NAM','1995-12-08','5000000','NV05','PB05'),
('NV07',N'ĐỖ THỊ THANH','NU','1995-12-01','5000000','NV04','PB04'),
('NV08',N'NGUYỄN DUY ANH','NAM','1995-12-02','5000000','NV01','PB01'),
('NV09',N'NGUYỄN DUY EM','NU','1995-03-12','5000000','NV01','PB02'),
('NV10',N'NGUYỄN MINH HIẾU','NAM','1995-12-05','5000000','NV05','PB05')


SELECT * FROM THANNHAN
INSERT INTO THANNHAN VALUES(N'BÙI DOÃN LẬP','NAM','1965-10-05','BO','NV01')

INSERT INTO THANNHAN 
VALUES(N'ĐỖ THÚY MAI','NU','1965-09-30','ME','NV01'),
(N'BÙI DOÃN CHIẾN','NAM','1964-11-05','BO','NV02'),
(N'NGUYỄN THỊ DUNG','NU','1960-12-05','ME','NV02'),
(N'BÙI QUANG HIẾU','NAM','1972-12-05','BO','NV03'),
(N'DƯƠNG VĂN HÙNG','NAM','1970-10-05','BO','NV04'),
(N'ĐỖ HỮU CHIẾN','NAM','1969-08-05','BO','NV05'),
(N'BÙI THỊ HOA','NU','1968-09-05','BO','NV06'),
(N'ĐỖ THỊ HỢI','NU','1967-01-05','BO','NV07'),
(N'NGUYỄN DUY HƯNG','NAM','1961-02-05','BO','NV08'),
(N'NGUYỄN DUY HƯNG','NAM','1961-02-05','BO','NV09'),
(N'NGUYỄN THỊ HOA','NU','1970-10-05','BO','NV10')

SELECT * FROM DUAN
INSERT INTO DUAN VALUES('DA01','DEAN1','PB01'),
						('DA02','DEAN2','PB02'),
						('DA03','DEAN3','PB03'),
						('DA04','DEAN4','PB04'),
						('DA05','DEAN5','PB05'),
						('DA06','DEAN6','PB04'),
						('DA07','DEAN7','PB03'),
						('DA08','DEAN8','PB02'),
						('DA09','DEAN9','PB01'),
						('DA10','DEAN10','PB05')

SELECT * FROM PHANCONG
INSERT INTO PHANCONG VALUES('DA01','NV01',10),
							('DA02','NV02',14),
							('DA03','NV03',11),
							('DA04','NV04',13),
							('DA05','NV05',9),
							('DA06','NV06',8),
							('DA07','NV07',4),
							('DA08','NV08',2),
							('DA09','NV09',4),
							('DA10','NV10',6)

SELECT * FROM DUAN
SELECT * FROM NHANVIEN
SELECT * FROM PHANCONG
SELECT * FROM PHONGBAN
SELECT * FROM THANNHAN


------------------------------------------------------------------------------------
ALTER TABLE DUAN ADD DIADIEM NVARCHAR(50)
UPDATE DUAN SET DIADIEM= N'Ha Noi'
WHERE MAPB='PB01'

SELECT MADA, MAPB,MATP,HOTEN, NGAYSINH
FROM DUAN D, PHONGBAN P, NHANVIEN N
WHERE D.MAPB=P.MAPB AND MATP=MANV
AND DIADIEM LIKE N'Ha Noi'


------------------------------------------------------------------------------------------------
#BUOI5

SELECT MAPB, COUNT(MANV) as'So nv'
FROM NHANVIEN
GROUP BY MAPB
---DEM SO PHONG CO NHAN VIEN >=3
SELECT MAPB, COUNT(MANV)
FROM NHANVIEN
GROUP BY MAPB
HAVING COUNT (MANV) >= 3
---dua ra mapb, so 
SELECT MAPB, COUNT (MANV)
FROM NHANVIEN
GROUP BY MAPB
HAVING COUNT (MANV) = ( ---dua ra so nhan vien lon nhat
SELECT MAX(SONV)
FROM ( ---dem so nhan vien theo tung phong ban
SELECT COUNT (MANV) SONV
FROM NHANVIEN
GROUP BY MAPB) AS B
)


--1.

